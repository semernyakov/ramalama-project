version: '3.8'

services:
  ramalama:
    build: .
    image: ramalama:latest
    container_name: ramalama
    env_file: .env
    profiles: ["main"]
    
    # Используем host network для доступа к прокси
    network_mode: host
    
    environment:
      # Настройки ramalama (загружаются из .env файла)
      - RAMALAMA_IN_CONTAINER=1
      
      # Дополнительные настройки для лучшего логирования
      - RAMALAMA_LOG_LEVEL=INFO
      - HF_HUB_DISABLE_PROGRESS_BARS=false
      - HF_HUB_ENABLE_HF_TRANSFER=1
    
    volumes:
      # Монтируем директории
      - ./models:/workspace/models
      - ./data:/workspace/data
    
    # По умолчанию показываем help
    command: ["tail", "-f", "/dev/null"]
    
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Альтернативный сервис без host network (если прокси не нужен)
  ramalama-no-proxy:
    build: .
    image: ramalama:latest
    container_name: ramalama-no-proxy
    profiles: ["no-proxy"]
    env_file: .env
    network_mode: bridge
    
    environment:
      # Переопределяем настройки для работы без прокси
      - HTTP_PROXY=
      - HTTPS_PROXY=
      - RAMALAMA_MODELS_PATH=/workspace/models
      - RAMALAMA_IN_CONTAINER=1
      
      # Дополнительные настройки для лучшего логирования
      - RAMALAMA_LOG_LEVEL=INFO
      - HF_HUB_DISABLE_PROGRESS_BARS=false
      - HF_HUB_ENABLE_HF_TRANSFER=1
    
    volumes:
      - ./models:/workspace/models
      - ./data:/workspace/data
      
    command: ["tail", "-f", "/dev/null"]
    
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Сервис для проверки монтирования (опционально)
  check-mounts:
    image: alpine:latest
    container_name: check-mounts
    profiles: ["check"]
    volumes:
      - ./models:/workspace/models
      - ./data:/workspace/data
    command: >
      sh -c "
        echo '=== ПРОВЕРКА МОНТИРОВАНИЯ ===' &&
        echo 'Текущая директория:' &&
        pwd &&
        echo '' &&
        echo 'Содержимое /workspace/models:' &&
        ls -la /workspace/models/ || echo 'Директория models не найдена' &&
        echo '' &&
        echo 'Содержимое /workspace/data:' &&
        ls -la /workspace/data/ || echo 'Директория data не найдена' &&
        echo '' &&
        echo 'Права на директории:' &&
        stat /workspace/models 2>/dev/null || echo 'Не удалось получить статистику models' &&
        stat /workspace/data 2>/dev/null || echo 'Не удалось получить статистику data' &&
        echo '=== КОНЕЦ ПРОВЕРКИ ==='
      "
