version: '3.8'

services:
  ramalama:
    build: .
    image: ramalama:latest
    container_name: ramalama
    
    # Use bridge network with proper port mapping for better security
    ports:
      - "8080:8080"
    networks:
      - ramalama-network
    
    env_file:
      - config/.env
    
    environment:
      # Proxy settings (from .env)
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=localhost,127.0.0.0/8,::1
      
      # CRITICAL: Specify where RamaLama should store models
      - RAMALAMA_STORE=/var/lib/ramalama
      - RAMALAMA_IN_CONTAINER=1
      - RAMALAMA_LOG_LEVEL=ERROR
      - RAMALAMA_ENGINE=llama.cpp
      
      # Log paths
      - RAMALAMA_LOG_FILE=/workspace/logs/ramalama.log
      
      # Hugging Face settings
      - HF_HUB_DISABLE_PROGRESS_BARS=false
      - HF_HUB_ENABLE_HF_TRANSFER=1
    
    volumes:
      # CRITICAL: Mount /var/lib/ramalama for model persistence!
      - ./models:/var/lib/ramalama:rw
      
      # Logs in separate directory
      - ./logs:/workspace/logs:rw
      
      # User data
      - ./data:/workspace/data:rw
      
      # Cache for performance
      - ./cache:/workspace/cache:rw
      
      # Configs in separate directory
      - ./config:/workspace/config:ro
    
    # Default container in waiting mode
    command: tail -f /dev/null
    
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Alternative service without proxy
  ramalama-no-proxy:
    build: .
    image: ramalama:latest
    container_name: ramalama-no-proxy
    profiles: ["no-proxy"]
    
    ports:
      - "8080:8080"
    networks:
      - ramalama-network
    
    environment:
      - RAMALAMA_STORE=/var/lib/ramalama
      - RAMALAMA_IN_CONTAINER=1
      - RAMALAMA_LOG_LEVEL=ERROR
      - RAMALAMA_ENGINE=llama.cpp
      - RAMALAMA_LOG_FILE=/workspace/logs/ramalama.log
    
    volumes:
      - ./models:/var/lib/ramalama:rw
      - ./logs:/workspace/logs:rw
      - ./data:/workspace/data:rw
      - ./cache:/workspace/cache:rw
      - ./config:/workspace/config:ro
    
    command: tail -f /dev/null
    
    stdin_open: true
    tty: true
    restart: unless-stopped

# Network configuration
networks:
  ramalama-network:
    driver: bridge
